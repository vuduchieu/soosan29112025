---
import BaseLayout from '../layouts/BaseLayout.astro';
import Layout from '../components/Layout.tsx';
import { getVisibleBlogPosts } from '../utils/contentCollections';
import { getBlogCategories } from '../utils/blogCategories';
import BlogCategoryFilter from '../components/blog/BlogCategoryFilter.tsx';
import BlogCategorySection from '../components/blog/BlogCategorySection.tsx';

const sortedPosts = await getVisibleBlogPosts();
const { categories, categoryMap, categoryInfoMap, getCategorySlug } = await getBlogCategories();

const getPostUrl = (post: any) => {
  const categorySlug = getCategorySlug(post.category);
  return `/blog/${categorySlug}/${post.slug}`;
};

const postsByCategory = categories.reduce((acc, cat) => {
  acc[cat.data.id] = sortedPosts.filter(post => post.category === cat.data.id);
  return acc;
}, {} as Record<string, any[]>);
---

<BaseLayout
  title="Tin Tức & Blog | Tin tức ngành vận tải, đánh giá xe"
  description="Cập nhật tin tức mới nhất về ngành vận tải, đánh giá xe tải, xe cẩu, kinh nghiệm lái xe và bảo dưỡng."
>
  <Layout client:load>
    <div class="container mx-auto px-4 py-8">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold mb-3 text-gray-900">Tin Tức & Blog</h1>
        <p class="text-gray-600 max-w-2xl mx-auto">
          Cập nhật tin tức mới nhất về ngành vận tải, đánh giá xe tải, xe cẩu, kinh nghiệm lái xe và bảo dưỡng
        </p>
      </div>

      <BlogCategoryFilter
        client:load
        categories={categories.map(cat => ({
          id: cat.data.id,
          name: cat.data.name,
          slug: cat.data.slug || cat.data.id,
          description: cat.data.description,
          icon: cat.data.icon,
          color: cat.data.color,
          order: cat.data.order
        }))}
      />

      <div class="space-y-12">
        {categories.map((category) => {
          const posts = postsByCategory[category.data.id];
          if (!posts || posts.length === 0) return null;

          return (
            <BlogCategorySection
              client:load
              key={category.data.id}
              categoryName={category.data.name}
              categorySlug={category.data.slug || category.data.id}
              posts={posts}
              getPostUrl={getPostUrl}
            />
          );
        })}
      </div>

      <div class="mt-12 bg-primary/5 rounded-lg p-8 text-center">
        <h3 class="text-2xl font-bold mb-3">Cần tư vấn về xe thương mại?</h3>
        <p class="text-gray-700 mb-6 max-w-xl mx-auto">
          Liên hệ ngay với chúng tôi để được tư vấn chi tiết về xe tải, xe cẩu, sơ mi rơ mooc và các sản phẩm khác
        </p>
        <a
          href="/lien-he"
          class="inline-block bg-primary text-white px-8 py-3 rounded-lg hover:bg-primary/90 transition font-medium"
        >
          Liên hệ ngay
        </a>
      </div>
    </div>
  </Layout>
</BaseLayout>
