---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Layout from '../../components/Layout.tsx';
import { OptimizedImage } from '../../components/ui/optimized-image.tsx';
import { getVisibleProducts, getCategoryById } from '../../utils/contentCollections';
import ProductDetailTabs from '../../components/TruckDetail/ProductDetailTabs.tsx';
import TruckItem from '../../components/TruckItem.tsx';
import TruckActions from '../../components/TruckDetail/TruckActions.tsx';

export async function getStaticPaths() {
  const trucks = await getVisibleProducts();

  return trucks.map((truck) => ({
    params: {
      type: truck.type,
      slug: truck.slug
    },
    props: { truck },
  }));
}

const { truck } = Astro.props;
const { type } = Astro.params;

if (!truck || truck.type !== type) {
  return Astro.redirect('/404');
}

const allTrucks = await getVisibleProducts();
const relatedTrucks = allTrucks
  .filter(t =>
    (t.brand === truck.brand ||
     Math.abs(t.weight - truck.weight) < 2) &&
    t.id !== truck.id
  )
  .slice(0, 4);

const category = await getCategoryById(truck.type);
const categoryName = category?.data.name || truck.type;
---

<BaseLayout
  title={`${truck.name} - ${categoryName} | soosanmotor.com`}
  description={truck.description}
>
  <Layout client:load>
    <div class="container mx-auto px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <OptimizedImage
            client:load
            src={truck.thumbnailUrl}
            alt={truck.name}
            className="w-full rounded-lg"
            useCase="product"
          />

          {truck.images && truck.images.length > 1 && (
            <div class="grid grid-cols-4 gap-2 mt-4">
              {truck.images.slice(1, 5).map((img: string) => (
                <OptimizedImage
                  client:load
                  key={img}
                  src={img}
                  alt={truck.name}
                  className="w-full rounded cursor-pointer hover:opacity-75"
                  useCase="thumbnail"
                />
              ))}
            </div>
          )}
        </div>

        <div>
          <h1 class="text-3xl font-bold mb-4">{truck.name}</h1>

          <div class="flex items-center gap-4 mb-6">
            {truck.isNew && (
              <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Mới</span>
            )}
            {truck.isHot && (
              <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">Hot</span>
            )}
          </div>

          <div class="bg-gray-50 p-6 rounded-lg mb-6">
            <div class="text-3xl font-bold text-primary mb-2">
              {truck.priceText}
            </div>
            <p class="text-gray-600">Giá có thể thay đổi theo cấu hình</p>
          </div>

          <div class="space-y-4 mb-6">
            <div class="flex justify-between">
              <span class="text-gray-600">Thương hiệu:</span>
              <span class="font-semibold">{truck.brand}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Tải trọng:</span>
              <span class="font-semibold">{truck.weightText}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Kích thước:</span>
              <span class="font-semibold">{truck.dimensions}</span>
            </div>
            {truck.origin && (
              <div class="flex justify-between">
                <span class="text-gray-600">Xuất xứ:</span>
                <span class="font-semibold">{truck.origin}</span>
              </div>
            )}
          </div>

          <TruckActions client:load truck={truck} />

          <div class="mt-6 p-4 bg-blue-50 rounded-lg">
            <p class="text-sm text-gray-700 mb-2">
              Liên hệ ngay để được tư vấn chi tiết và báo giá tốt nhất!
            </p>
            <a
              href="tel:0764678901"
              class="flex items-center justify-center gap-2 bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-700 transition"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
              </svg>
              Gọi ngay: 0764 6789 01
            </a>
          </div>
        </div>
      </div>

      <ProductDetailTabs client:only="react" truck={truck} />

      {relatedTrucks.length > 0 && (
        <div class="mt-16">
          <h2 class="text-2xl font-bold mb-6">Sản phẩm liên quan</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {relatedTrucks.map((relatedTruck) => (
              <TruckItem client:load key={relatedTruck.id} truck={relatedTruck} />
            ))}
          </div>
        </div>
      )}
    </div>
  </Layout>
</BaseLayout>
